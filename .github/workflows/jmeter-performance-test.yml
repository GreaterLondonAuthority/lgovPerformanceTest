name: JMeter Performance Test

on:
  push:
    branches: [ develop, main, oldTestsforPerformancetestUploaded ]
  workflow_dispatch:
    inputs:
      test_to_run:
        description: 'Select test to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - BrowseNormal-Baseline-1VU
          - BrowseNormal-VURamp1
          - SimpleSearch-Baseline-1VU
          - SimpleSearch-VURamp1

permissions:
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      run_browsenormal_baseline: ${{ steps.check.outputs.run_browsenormal_baseline }}
      run_browsenormal_vuramp: ${{ steps.check.outputs.run_browsenormal_vuramp }}
      run_simplesearch_baseline: ${{ steps.check.outputs.run_simplesearch_baseline }}
      run_simplesearch_vuramp: ${{ steps.check.outputs.run_simplesearch_vuramp }}
    steps:
      - name: Check which tests to run
        id: check
        run: |
          TEST="${{ github.event.inputs.test_to_run }}"
          if [ -z "$TEST" ] || [ "$TEST" = "all" ]; then
            echo "run_browsenormal_baseline=true" >> $GITHUB_OUTPUT
            echo "run_browsenormal_vuramp=true" >> $GITHUB_OUTPUT
            echo "run_simplesearch_baseline=true" >> $GITHUB_OUTPUT
            echo "run_simplesearch_vuramp=true" >> $GITHUB_OUTPUT
          else
            echo "run_browsenormal_baseline=${{ github.event.inputs.test_to_run == 'BrowseNormal-Baseline-1VU' }}" >> $GITHUB_OUTPUT
            echo "run_browsenormal_vuramp=${{ github.event.inputs.test_to_run == 'BrowseNormal-VURamp1' }}" >> $GITHUB_OUTPUT
            echo "run_simplesearch_baseline=${{ github.event.inputs.test_to_run == 'SimpleSearch-Baseline-1VU' }}" >> $GITHUB_OUTPUT
            echo "run_simplesearch_vuramp=${{ github.event.inputs.test_to_run == 'SimpleSearch-VURamp1' }}" >> $GITHUB_OUTPUT
          fi

  browsenormal-baseline:
    needs: setup
    if: needs.setup.outputs.run_browsenormal_baseline == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      JMETER_VERSION: "5.6.3"
      TEST_NAME: "BrowseNormal-Baseline-1VU"
      TEST_PATH: "Performancestests/LGOV/BrowseNormal/Baseline-1VU"
      TEST_JMX: "LGOV-PerfTest-BrowseNormal-Baseline-1VU.jmx"
      TEST_TYPE: "baseline"
      AUTH_USERNAME: ${{ secrets.JMETER_AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.JMETER_AUTH_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install JMeter
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
          echo "$PWD/apache-jmeter-${JMETER_VERSION}/bin" >> $GITHUB_PATH

      - name: Install JMeter Plugins
        run: |
          set -e
          cd apache-jmeter-${JMETER_VERSION}/lib/ext
          
          # Install JMeter Plugins Manager
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.10/jmeter-plugins-manager-1.10.jar
          
          # Install required plugins for UltimateThreadGroup, Throughput Shaping Timer, and Graphs
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-casutg/2.10/jmeter-plugins-casutg-2.10.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-tst/2.6/jmeter-plugins-tst-2.6.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-basic/2.0/jmeter-plugins-graphs-basic-2.0.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-additional/2.0/jmeter-plugins-graphs-additional-2.0.jar
          
          # Install JMeter Plugins Common classes (required dependency)
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-cmn-jmeter/0.7/jmeter-plugins-cmn-jmeter-0.7.jar
          
          cd ../../..
          echo "âœ… JMeter plugins installed"

      - name: Verify JMeter installation
        run: jmeter --version

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run JMeter Test - ${{ env.TEST_NAME }}
        run: |
          set -euo pipefail
          
          # Navigate to test directory
          cd ${{ env.TEST_PATH }}
          
          # Create artifacts directory in repo root
          mkdir -p ../../../../artifacts/${{ env.TEST_NAME }}
          
          # Load test parameters from test.yml
          START_THREADS=$(yq '.thread-config.start-threads' test.yml)
          INITIAL_DELAY=$(yq '.thread-config.initial-delay' test.yml)
          STARTUP_TIME=$(yq '.thread-config.startup-time' test.yml)
          HOLD_LOAD=$(yq '.thread-config.hold-load' test.yml)
          SHUTDOWN_TIME=$(yq '.thread-config.shutdown-time' test.yml)
          
          # Load authorization parameters from test.yml
          AUTHORIZATION_URL=$(yq '.authorization.url' test.yml)
          DOMAIN=$(yq '.authorization.domain' test.yml)
          EMBEDDED_URL_RE=$(yq '.authorization.embedded_url_re' test.yml)
          
          echo "ðŸš€ Starting JMeter performance test..."
          echo "ðŸ“ Test Plan: ${{ env.TEST_NAME }}"
          echo "â±ï¸  Hold Load: $HOLD_LOAD seconds"
          echo "ðŸ‘¥ Users: $START_THREADS concurrent"
          echo "ðŸŽ¯ Target: lgov-perftest.london.gov.uk"
          
          # Build JMeter command
          JMETER_CMD="jmeter -n -t ${{ env.TEST_JMX }} \
            -l ../../../../artifacts/${{ env.TEST_NAME }}/results.jtl \
            -j ../../../../artifacts/${{ env.TEST_NAME }}/jmeter.log \
            -e -o ../../../../artifacts/${{ env.TEST_NAME }}/html-report \
            -JSTART_THREADS=${START_THREADS} \
            -JINITIAL_DELAY=${INITIAL_DELAY} \
            -JSTARTUP_TIME=${STARTUP_TIME} \
            -JHOLD_LOAD=${HOLD_LOAD} \
            -JSHUTDOWN_TIME=${SHUTDOWN_TIME} \
            -JAUTHORIZATION_URL=${AUTHORIZATION_URL} \
            -JDOMAIN=${DOMAIN} \
            -JEMBEDDED_URL_RE=${EMBEDDED_URL_RE} \
            -JAUTH_USERNAME=${{ env.AUTH_USERNAME }} \
            -JAUTH_PASSWORD=${{ env.AUTH_PASSWORD }}"
          
          # Execute JMeter
          eval $JMETER_CMD
          
          echo "ðŸ JMeter test completed!"

      - name: Display Test Results Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results Summary - ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/${{ env.TEST_NAME }}/results.jtl ]; then
            TOTAL_SAMPLES=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | wc -l)
            ERRORS=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | awk -F',' '{print $8}' | grep -c "false" || echo "0")
            
            if [ "$TOTAL_SAMPLES" -gt 0 ]; then
              SUCCESS_RATE=$(awk -v total="$TOTAL_SAMPLES" -v errors="$ERRORS" 'BEGIN {printf "%.2f%%", ((total-errors)/total)*100}')
            else
              SUCCESS_RATE="0%"
            fi
            
            echo "- **Test Plan:** ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Requests:** $TOTAL_SAMPLES" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Success Rate:** $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload JMeter Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ env.TEST_NAME }}
          path: artifacts/${{ env.TEST_NAME }}/
          retention-days: 14

  browsenormal-vuramp:
    needs: setup
    if: needs.setup.outputs.run_browsenormal_vuramp == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      JMETER_VERSION: "5.6.3"
      TEST_NAME: "BrowseNormal-VURamp1"
      TEST_PATH: "Performancestests/LGOV/BrowseNormal/VURamp1"
      TEST_JMX: "LGOV-PerfTest-BrowseNormal-VURamp1.jmx"
      TEST_TYPE: "vuramp"
      AUTH_USERNAME: ${{ secrets.JMETER_AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.JMETER_AUTH_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install JMeter
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
          echo "$PWD/apache-jmeter-${JMETER_VERSION}/bin" >> $GITHUB_PATH

      - name: Install JMeter Plugins
        run: |
          set -e
          cd apache-jmeter-${JMETER_VERSION}/lib/ext
          
          # Install JMeter Plugins Manager
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.10/jmeter-plugins-manager-1.10.jar
          
          # Install required plugins for UltimateThreadGroup, Throughput Shaping Timer, and Graphs
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-casutg/2.10/jmeter-plugins-casutg-2.10.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-tst/2.6/jmeter-plugins-tst-2.6.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-basic/2.0/jmeter-plugins-graphs-basic-2.0.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-additional/2.0/jmeter-plugins-graphs-additional-2.0.jar
          
          # Install JMeter Plugins Common classes (required dependency)
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-cmn-jmeter/0.7/jmeter-plugins-cmn-jmeter-0.7.jar
          
          cd ../../..
          echo "âœ… JMeter plugins installed"

      - name: Verify JMeter installation
        run: jmeter --version

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run JMeter Test - ${{ env.TEST_NAME }}
        run: |
          set -euo pipefail
          
          # Navigate to test directory
          cd ${{ env.TEST_PATH }}
          
          # Create artifacts directory in repo root
          mkdir -p ../../../../artifacts/${{ env.TEST_NAME }}
          
          # Load test parameters from test.yml
          START_THREADS=$(yq '.thread-config.start-threads' test.yml)
          INITIAL_DELAY=$(yq '.thread-config.initial-delay' test.yml)
          STARTUP_TIME=$(yq '.thread-config.startup-time' test.yml)
          HOLD_LOAD=$(yq '.thread-config.hold-load' test.yml)
          SHUTDOWN_TIME=$(yq '.thread-config.shutdown-time' test.yml)
          
          RPS_START=$(yq '.throughput-config.ramp-phase.start-rps' test.yml)
          RPS_END=$(yq '.throughput-config.ramp-phase.end-rps' test.yml)
          RAMP_DURATION=$(yq '.throughput-config.ramp-phase.duration' test.yml)
          HOLD_DURATION=$(yq '.throughput-config.hold-phase.duration' test.yml)
          
          # Load authorization parameters from test.yml
          AUTHORIZATION_URL=$(yq '.authorization.url' test.yml)
          EMBEDDED_URL_RE=$(yq '.authorization.embedded_url_re' test.yml)
          
          echo "ðŸš€ Starting JMeter performance test..."
          echo "ðŸ“ Test Plan: ${{ env.TEST_NAME }}"
          echo "â±ï¸  Hold Load: $HOLD_LOAD seconds"
          echo "ðŸ‘¥ Users: $START_THREADS concurrent"
          echo "ðŸ”§ Throughput: ${RPS_START} â†’ ${RPS_END} RPS over ${RAMP_DURATION}s"
          echo "ðŸŽ¯ Target: lgov-perftest.london.gov.uk"
          
          # Build JMeter command with throughput parameters
          jmeter -n -t ${{ env.TEST_JMX }} \
            -l ../../../../artifacts/${{ env.TEST_NAME }}/results.jtl \
            -j ../../../../artifacts/${{ env.TEST_NAME }}/jmeter.log \
            -e -o ../../../../artifacts/${{ env.TEST_NAME }}/html-report \
            -JSTART_THREADS=${START_THREADS} \
            -JINITIAL_DELAY=${INITIAL_DELAY} \
            -JSTARTUP_TIME=${STARTUP_TIME} \
            -JHOLD_LOAD=${HOLD_LOAD} \
            -JSHUTDOWN_TIME=${SHUTDOWN_TIME} \
            -JRPS_START=${RPS_START} \
            -JRPS_END=${RPS_END} \
            -JRAMP_DURATION=${RAMP_DURATION} \
            -JHOLD_DURATION=${HOLD_DURATION} \
            -JAUTHORIZATION_URL=${AUTHORIZATION_URL} \
            -JEMBEDDED_URL_RE=${EMBEDDED_URL_RE} \
            -JAUTH_USERNAME=${{ env.AUTH_USERNAME }} \
            -JAUTH_PASSWORD=${{ env.AUTH_PASSWORD }}
          
          echo "ðŸ JMeter test completed!"

      - name: Display Test Results Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results Summary - ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/${{ env.TEST_NAME }}/results.jtl ]; then
            TOTAL_SAMPLES=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | wc -l)
            ERRORS=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | awk -F',' '{print $8}' | grep -c "false" || echo "0")
            
            if [ "$TOTAL_SAMPLES" -gt 0 ]; then
              SUCCESS_RATE=$(awk -v total="$TOTAL_SAMPLES" -v errors="$ERRORS" 'BEGIN {printf "%.2f%%", ((total-errors)/total)*100}')
            else
              SUCCESS_RATE="0%"
            fi
            
            echo "- **Test Plan:** ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Requests:** $TOTAL_SAMPLES" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Success Rate:** $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload JMeter Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ env.TEST_NAME }}
          path: artifacts/${{ env.TEST_NAME }}/
          retention-days: 14

  simplesearch-baseline:
    needs: setup
    if: needs.setup.outputs.run_simplesearch_baseline == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      JMETER_VERSION: "5.6.3"
      TEST_NAME: "SimpleSearch-Baseline-1VU"
      TEST_PATH: "Performancestests/LGOV/SimpleSearch/Baseline-1VU"
      TEST_JMX: "LGOV-PerfTest-SimpleSearch-Baseline-1VU.jmx"
      TEST_TYPE: "baseline"
      AUTH_USERNAME: ${{ secrets.JMETER_AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.JMETER_AUTH_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install JMeter
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
          echo "$PWD/apache-jmeter-${JMETER_VERSION}/bin" >> $GITHUB_PATH

      - name: Install JMeter Plugins
        run: |
          set -e
          cd apache-jmeter-${JMETER_VERSION}/lib/ext
          
          # Install JMeter Plugins Manager
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.10/jmeter-plugins-manager-1.10.jar
          
          # Install required plugins for UltimateThreadGroup, Throughput Shaping Timer, and Graphs
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-casutg/2.10/jmeter-plugins-casutg-2.10.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-tst/2.6/jmeter-plugins-tst-2.6.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-basic/2.0/jmeter-plugins-graphs-basic-2.0.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-additional/2.0/jmeter-plugins-graphs-additional-2.0.jar
          
          # Install JMeter Plugins Common classes (required dependency)
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-cmn-jmeter/0.7/jmeter-plugins-cmn-jmeter-0.7.jar
          
          cd ../../..
          echo "âœ… JMeter plugins installed"

      - name: Verify JMeter installation
        run: jmeter --version

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run JMeter Test - ${{ env.TEST_NAME }}
        run: |
          set -euo pipefail
          
          # Navigate to test directory
          cd ${{ env.TEST_PATH }}
          
          # Create artifacts directory in repo root
          mkdir -p ../../../../artifacts/${{ env.TEST_NAME }}
          
          # Load test parameters from test.yml
          START_THREADS=$(yq '.thread-config.start-threads' test.yml)
          INITIAL_DELAY=$(yq '.thread-config.initial-delay' test.yml)
          STARTUP_TIME=$(yq '.thread-config.startup-time' test.yml)
          HOLD_LOAD=$(yq '.thread-config.hold-load' test.yml)
          SHUTDOWN_TIME=$(yq '.thread-config.shutdown-time' test.yml)
          
          # Load authorization parameters from test.yml
          AUTHORIZATION_URL=$(yq '.authorization.url' test.yml)
          EMBEDDED_URL_RE=$(yq '.authorization.embedded_url_re' test.yml)
          
          echo "ðŸš€ Starting JMeter performance test..."
          echo "ðŸ“ Test Plan: ${{ env.TEST_NAME }}"
          echo "â±ï¸  Hold Load: $HOLD_LOAD seconds"
          echo "ðŸ‘¥ Users: $START_THREADS concurrent"
          echo "ðŸŽ¯ Target: lgov-perftest.london.gov.uk"
          
          # Build JMeter command
          jmeter -n -t ${{ env.TEST_JMX }} \
            -l ../../../../artifacts/${{ env.TEST_NAME }}/results.jtl \
            -j ../../../../artifacts/${{ env.TEST_NAME }}/jmeter.log \
            -e -o ../../../../artifacts/${{ env.TEST_NAME }}/html-report \
            -JSTART_THREADS=${START_THREADS} \
            -JINITIAL_DELAY=${INITIAL_DELAY} \
            -JSTARTUP_TIME=${STARTUP_TIME} \
            -JHOLD_LOAD=${HOLD_LOAD} \
            -JSHUTDOWN_TIME=${SHUTDOWN_TIME} \
            -JAUTHORIZATION_URL=${AUTHORIZATION_URL} \
            -JEMBEDDED_URL_RE=${EMBEDDED_URL_RE} \
            -JAUTH_USERNAME=${{ env.AUTH_USERNAME }} \
            -JAUTH_PASSWORD=${{ env.AUTH_PASSWORD }}
          
          echo "ðŸ JMeter test completed!"

      - name: Display Test Results Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results Summary - ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/${{ env.TEST_NAME }}/results.jtl ]; then
            TOTAL_SAMPLES=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | wc -l)
            ERRORS=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | awk -F',' '{print $8}' | grep -c "false" || echo "0")
            
            if [ "$TOTAL_SAMPLES" -gt 0 ]; then
              SUCCESS_RATE=$(awk -v total="$TOTAL_SAMPLES" -v errors="$ERRORS" 'BEGIN {printf "%.2f%%", ((total-errors)/total)*100}')
            else
              SUCCESS_RATE="0%"
            fi
            
            echo "- **Test Plan:** ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Requests:** $TOTAL_SAMPLES" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Success Rate:** $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload JMeter Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ env.TEST_NAME }}
          path: artifacts/${{ env.TEST_NAME }}/
          retention-days: 14

  simplesearch-vuramp:
    needs: setup
    if: needs.setup.outputs.run_simplesearch_vuramp == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      JMETER_VERSION: "5.6.3"
      TEST_NAME: "SimpleSearch-VURamp1"
      TEST_PATH: "Performancestests/LGOV/SimpleSearch/VURamp1"
      TEST_JMX: "LGOV-PerfTest-SimpleSearch-VURamp1.jmx"
      TEST_TYPE: "vuramp"
      AUTH_USERNAME: ${{ secrets.JMETER_AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.JMETER_AUTH_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install JMeter
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
          echo "$PWD/apache-jmeter-${JMETER_VERSION}/bin" >> $GITHUB_PATH

      - name: Install JMeter Plugins
        run: |
          set -e
          cd apache-jmeter-${JMETER_VERSION}/lib/ext
          
          # Install JMeter Plugins Manager
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.10/jmeter-plugins-manager-1.10.jar
          
          # Install required plugins for UltimateThreadGroup, Throughput Shaping Timer, and Graphs
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-casutg/2.10/jmeter-plugins-casutg-2.10.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-tst/2.6/jmeter-plugins-tst-2.6.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-basic/2.0/jmeter-plugins-graphs-basic-2.0.jar
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-graphs-additional/2.0/jmeter-plugins-graphs-additional-2.0.jar
          
          # Install JMeter Plugins Common classes (required dependency)
          wget -q https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-cmn-jmeter/0.7/jmeter-plugins-cmn-jmeter-0.7.jar
          
          cd ../../..
          echo "âœ… JMeter plugins installed"

      - name: Verify JMeter installation
        run: jmeter --version

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run JMeter Test - ${{ env.TEST_NAME }}
        run: |
          set -euo pipefail
          
          # Navigate to test directory
          cd ${{ env.TEST_PATH }}
          
          # Create artifacts directory in repo root
          mkdir -p ../../../../artifacts/${{ env.TEST_NAME }}
          
          # Load test parameters from test.yml
          START_THREADS=$(yq '.thread-config.start-threads' test.yml)
          INITIAL_DELAY=$(yq '.thread-config.initial-delay' test.yml)
          STARTUP_TIME=$(yq '.thread-config.startup-time' test.yml)
          HOLD_LOAD=$(yq '.thread-config.hold-load' test.yml)
          SHUTDOWN_TIME=$(yq '.thread-config.shutdown-time' test.yml)
          
          RPS_START=$(yq '.throughput-config.ramp-phase.start-rps' test.yml)
          RPS_END=$(yq '.throughput-config.ramp-phase.end-rps' test.yml)
          RAMP_DURATION=$(yq '.throughput-config.ramp-phase.duration' test.yml)
          HOLD_DURATION=$(yq '.throughput-config.hold-phase.duration' test.yml)
          
          # Load authorization parameters from test.yml
          AUTHORIZATION_URL=$(yq '.authorization.url' test.yml)
          EMBEDDED_URL_RE=$(yq '.authorization.embedded_url_re' test.yml)
          
          echo "ðŸš€ Starting JMeter performance test..."
          echo "ðŸ“ Test Plan: ${{ env.TEST_NAME }}"
          echo "â±ï¸  Hold Load: $HOLD_LOAD seconds"
          echo "ðŸ‘¥ Users: $START_THREADS concurrent"
          echo "ðŸ”§ Throughput: ${RPS_START} â†’ ${RPS_END} RPS over ${RAMP_DURATION}s"
          echo "ðŸŽ¯ Target: lgov-perftest.london.gov.uk"
          
          # Build JMeter command with throughput parameters
          jmeter -n -t ${{ env.TEST_JMX }} \
            -l ../../../../artifacts/${{ env.TEST_NAME }}/results.jtl \
            -j ../../../../artifacts/${{ env.TEST_NAME }}/jmeter.log \
            -e -o ../../../../artifacts/${{ env.TEST_NAME }}/html-report \
            -JSTART_THREADS=${START_THREADS} \
            -JINITIAL_DELAY=${INITIAL_DELAY} \
            -JSTARTUP_TIME=${STARTUP_TIME} \
            -JHOLD_LOAD=${HOLD_LOAD} \
            -JSHUTDOWN_TIME=${SHUTDOWN_TIME} \
            -JRPS_START=${RPS_START} \
            -JRPS_END=${RPS_END} \
            -JRAMP_DURATION=${RAMP_DURATION} \
            -JHOLD_DURATION=${HOLD_DURATION} \
            -JAUTHORIZATION_URL=${AUTHORIZATION_URL} \
            -JEMBEDDED_URL_RE=${EMBEDDED_URL_RE} \
            -JAUTH_USERNAME=${{ env.AUTH_USERNAME }} \
            -JAUTH_PASSWORD=${{ env.AUTH_PASSWORD }}
          
          echo "ðŸ JMeter test completed!"

      - name: Display Test Results Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results Summary - ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/${{ env.TEST_NAME }}/results.jtl ]; then
            TOTAL_SAMPLES=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | wc -l)
            ERRORS=$(tail -n +2 artifacts/${{ env.TEST_NAME }}/results.jtl | awk -F',' '{print $8}' | grep -c "false" || echo "0")
            
            if [ "$TOTAL_SAMPLES" -gt 0 ]; then
              SUCCESS_RATE=$(awk -v total="$TOTAL_SAMPLES" -v errors="$ERRORS" 'BEGIN {printf "%.2f%%", ((total-errors)/total)*100}')
            else
              SUCCESS_RATE="0%"
            fi
            
            echo "- **Test Plan:** ${{ env.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Requests:** $TOTAL_SAMPLES" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Success Rate:** $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload JMeter Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ env.TEST_NAME }}
          path: artifacts/${{ env.TEST_NAME }}/
          retention-days: 14
